// File: D:\docs\test\Decode\DreamDecode\DreamDecode\Program.cs

using System.Security.Claims;
using System.Text;
using DreamDecode.Application;
using DreamDecode.Domain.User.Entities;
using DreamDecode.Domain.User.Enums;
using DreamDecode.Infrastructure;
using Microsoft.AspNetCore.Authentication.JwtBearer;
using Microsoft.AspNetCore.Identity;
using Microsoft.IdentityModel.Tokens;
using Microsoft.OpenApi.Models;

var builder = WebApplication.CreateBuilder(args);

// Add services to the container.
builder.Services.AddInfrastructure(builder.Configuration); // from Infrastructure
builder.Services.AddApplication(); // from Application
builder.Services.AddControllers();

var key = Encoding.UTF8.GetBytes(builder.Configuration["Jwt:Key"]!);
builder.Services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
    .AddJwtBearer(o =>
    {
        o.TokenValidationParameters = new TokenValidationParameters
        {
            ValidateIssuer = true,
            ValidateAudience = true,
            ValidateLifetime = true,
            ValidateIssuerSigningKey = true,
            ValidIssuer = builder.Configuration["Jwt:Issuer"],
            ValidAudience = builder.Configuration["Jwt:Audience"],
            IssuerSigningKey = new SymmetricSecurityKey(key),
            RoleClaimType=ClaimTypes.Role
        };
    });



builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen(c =>
{
    c.SwaggerDoc("v1", new OpenApiInfo
    {
        Title = "DreamDecode API",
        Version = "v1",
        Description = "API for DreamDecode application"
    });

    c.AddSecurityDefinition("Bearer", new OpenApiSecurityScheme
    {
        Description = "JWT Authorization header using the Bearer scheme. Example: \"Bearer {token}\"",
        Name = "Authorization",
        In = ParameterLocation.Header,
        Type = SecuritySchemeType.ApiKey,
        Scheme = "Bearer"
    });


});

var app = builder.Build();
app.Use(async (context, next) =>
{
    if (context.User.Identity.IsAuthenticated)
    {
        Console.WriteLine("User claims:");
        foreach (var claim in context.User.Claims)
        {
            Console.WriteLine($"{claim.Type}: {claim.Value}");
        }
    }
    await next();
});
app.UseSwagger();
app.UseSwaggerUI(c =>
{
    c.SwaggerEndpoint("/swagger/v1/swagger.json", "DreamDecode API V1");
    c.RoutePrefix = string.Empty; // Set Swagger UI at the root
});
app.UseHttpsRedirection();

app.UseAuthentication();

app.UseAuthorization();

app.MapControllers();
await SeedDefaultsAsync(app.Services); // seed roles & default admin

app.Run();

// local method: seed roles & an admin
static async Task SeedDefaultsAsync(IServiceProvider sp)
{
    using var scope = sp.CreateScope();
    var roles = scope.ServiceProvider.GetRequiredService<RoleManager<IdentityRole>>();
    var users = scope.ServiceProvider.GetRequiredService<UserManager<ApplicationUser>>();

    foreach (var r in new[] { Roles.Admin.ToString(), Roles.User.ToString() })
        if (!await roles.RoleExistsAsync(r)) await roles.CreateAsync(new IdentityRole(r));

    var adminEmail = "admin@dreams.com";
    var admin = await users.FindByEmailAsync(adminEmail);
    if (admin is null)
    {
        admin = new ApplicationUser { Email = adminEmail, UserName = adminEmail, FullName = "Dreams Admin" };
        await users.CreateAsync(admin, "Admin#12345");
        await users.AddToRoleAsync(admin, Roles.Admin.ToString());
    }
}

--------------------------------------------------------------------------------

// File: D:\docs\test\Decode\DreamDecode\DreamDecode\Controllers\AdminController.cs

using DreamDecode.Application.Interpretation.Interfaces;
using DreamDecode.Application.Interpretation.Services;
using DreamDecode.Application.User.DTOs;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc;

namespace DreamDecode.API.Controllers
{
    
   // [Authorize(Roles = "Admin")]
    [ApiController]
    [Route("api/[controller]")]
    public class AdminController : ControllerBase
    {
        private readonly IAdminManagement _adminService;

        public AdminController(IAdminManagement adminService)
        {
            _adminService = adminService;
        }

        [HttpPost("add")]
        public async Task<IActionResult> AddAdmin(RegisterDto dto)
        {
            var test = User.Identity.IsAuthenticated;
            var claims = User.Claims.Select(c => new { c.Type, c.Value }).ToList();
          var result = await _adminService.AddAdminAsync(dto);
            return Ok(result);
        }

        [Authorize(Roles = "Admin")]
        [HttpDelete("delete")]
        public async Task<IActionResult> DeleteAdmin(string email)
        {
            var result = await _adminService.DeleteAdminAsync(email);
            return Ok(result);
        }
    }

}


--------------------------------------------------------------------------------

// File: D:\docs\test\Decode\DreamDecode\DreamDecode\Controllers\AuthController.cs

using DreamDecode.Application.User.DTOs;
using DreamDecode.Application.User.Interfaces;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc;

namespace DreamDecode.API.Controllers
{
    [Route("api/[controller]")]
    [ApiController]
    public class AuthController : ControllerBase
    {
        private readonly IAuthService _auth;
        public AuthController(IAuthService auth) => _auth = auth;

        [HttpPost("register")]
        public async Task<IActionResult> Register([FromBody] RegisterDto dto)
        {
            var res = await _auth.RegisterAsync(dto);
            return res.Succeeded ? Ok(res) : BadRequest(res);
        }

        [HttpPost("login")]
        public async Task<IActionResult> Login([FromBody] LoginDto dto)
        {
            var res = await _auth.LoginAsync(dto);
            return res.Succeeded ? Ok(res) : BadRequest(res);
        }
    }
}


--------------------------------------------------------------------------------

// File: D:\docs\test\Decode\DreamDecode\DreamDecode\Controllers\DreamController.cs

using DreamDecode.Application.Dream.DTOs;
using DreamDecode.Application.Dream.Interfaces;
using Microsoft.AspNetCore.Authorization;
using System.Security.Claims;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc;
using DreamDecode.Application.Dream.Services;

namespace DreamDecode.API.Controllers
{
   
    [ApiController]
    [Route("api/[controller]")]
    public class DreamController : ControllerBase
    {
        private readonly IDreamService _dreamService;
       

        public DreamController(IDreamService dreamService)
        {
            _dreamService = dreamService;
           
        }

        [HttpPost("add")]
        public async Task<IActionResult> Add(DreamCreateDto dto)
        {
            var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
            if (userId == null)
            {
                return Unauthorized();
            }
            var dream = await _dreamService.AddDreamAsync(dto,userId);
            return Ok(dream);
        }

        [HttpGet("my-dreams")]
        public async Task<IActionResult> GetUserDreams()
        {
            var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
            var dreams = await _dreamService.GetUserDreamsAsync(userId);
            return Ok(dreams);
        }

        [Authorize(Roles = "Admin")]
        [HttpGet("all")]
        public async Task<IActionResult> GetAll()
        {
            var dreams = await _dreamService.GetAllDreamsAsync();
            return Ok(dreams);
        }
    }
}


--------------------------------------------------------------------------------

// File: D:\docs\test\Decode\DreamDecode\DreamDecode.Application\DependancyInjection.cs

using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using DreamDecode.Application.Dream.Interfaces;
using DreamDecode.Application.Dream.Services;
using DreamDecode.Application.Interpretation.Interfaces;
using DreamDecode.Application.Interpretation.Services;
using DreamDecode.Application.User.Interfaces;
using DreamDecode.Application.User.Services;
using Microsoft.Extensions.DependencyInjection;

namespace DreamDecode.Application
{
    public static class DependancyInjection
    {
        public static IServiceCollection AddApplication(this IServiceCollection services)
        {
            services.AddScoped<IAuthService, AuthService>();
            services.AddScoped<IAdminManagement, AdminManagementService>();
            services.AddScoped<IDreamService, DreamService>();
            services.AddHttpContextAccessor();
            services.AddScoped<CurrentUserService>();
            return services;
        }
    }
}


--------------------------------------------------------------------------------

// File: D:\docs\test\Decode\DreamDecode\DreamDecode.Application\Dream\DTOs\DreamCreateDto.cs

using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace DreamDecode.Application.Dream.DTOs
{
    public class DreamCreateDto
    {
        public string Title { get; set; }
        public string Description { get; set; }
        public bool IsPaid { get; set; }
    }

}


--------------------------------------------------------------------------------

// File: D:\docs\test\Decode\DreamDecode\DreamDecode.Application\Dream\DTOs\DreamDto.cs

using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace DreamDecode.Application.Dream.DTOs
{
    public class DreamDto
    {
        public int DreamId { get; set; }
        public string Title { get; set; }
        public string Description { get; set; }
        public DateTime SubmittedAt { get; set; }
        public bool IsInterpreted { get; set; }
        public bool IsPaid { get; set; }
    }
}


--------------------------------------------------------------------------------

// File: D:\docs\test\Decode\DreamDecode\DreamDecode.Application\Dream\Interfaces\IDreamService.cs

using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using DreamDecode.Application.Dream.DTOs;

namespace DreamDecode.Application.Dream.Interfaces
{
    public interface IDreamService
    {
        Task<DreamDto> AddDreamAsync(DreamCreateDto dto, string userId);
        Task<IEnumerable<DreamDto>> GetUserDreamsAsync(string userId);
        Task<IEnumerable<DreamDto>> GetAllDreamsAsync();
    }
}


--------------------------------------------------------------------------------

// File: D:\docs\test\Decode\DreamDecode\DreamDecode.Application\Dream\Services\DreamService.cs

using System;
using System.Collections.Generic;
using System.Linq;
using System.Security.Claims;
using System.Text;
using System.Threading.Tasks;
using DreamDecode.Application.Dream.DTOs;
using DreamDecode.Application.Dream.Interfaces;
using DreamDecode.Domain.Dream.Entities;
using DreamDecode.Infrastructure.Data;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;

namespace DreamDecode.Application.Dream.Services
{
    public class DreamService : IDreamService
    {
        private readonly AppDbContext _context;
        private readonly CurrentUserService getCurrentUser;
        

        public DreamService(AppDbContext context, CurrentUserService getCurrentUser)
        {
            _context = context;
            this.getCurrentUser = getCurrentUser;
           
        }

       
        public async Task<DreamDto> AddDreamAsync(DreamCreateDto dto, string userId)
        {
            
          
            var dream = new DreamEntity
            {
                Title = dto.Title,
                Description = dto.Description,
                UserId = userId,
                IsPaid = dto.IsPaid
            };

            _context.Dreams.Add(dream);
            await _context.SaveChangesAsync();

            return new DreamDto
            {
                DreamId = dream.DreamId,
                Title = dream.Title,
                Description = dream.Description,
                SubmittedAt = dream.SubmittedAt,
                IsInterpreted = dream.IsInterpreted,
                IsPaid = dream.IsPaid
            };
        }

        public async Task<IEnumerable<DreamDto>> GetUserDreamsAsync(string userId)
        {
            return await _context.Dreams
                .Where(d => d.UserId == userId)
                .Select(d => new DreamDto
                {
                    DreamId = d.DreamId,
                    Title = d.Title,
                    Description = d.Description,
                    SubmittedAt = d.SubmittedAt,
                    IsInterpreted = d.IsInterpreted,
                    IsPaid = d.IsPaid
                })
                .ToListAsync();
        }

        public async Task<IEnumerable<DreamDto>> GetAllDreamsAsync()
        {
            return await _context.Dreams
                .Select(d => new DreamDto
                {
                    DreamId = d.DreamId,
                    Title = d.Title,
                    Description = d.Description,
                    SubmittedAt = d.SubmittedAt,
                    IsInterpreted = d.IsInterpreted,
                    IsPaid = d.IsPaid
                })
                .ToListAsync();
        }
    }
}


--------------------------------------------------------------------------------

// File: D:\docs\test\Decode\DreamDecode\DreamDecode.Application\Dream\Services\GetCurrentUserService.cs

using System;
using System.Collections.Generic;
using System.Linq;
using System.Security.Claims;
using System.Text;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Http;

namespace DreamDecode.Application.Dream.Services
{
    public class CurrentUserService
    {
        private readonly IHttpContextAccessor _httpContextAccessor;

        public CurrentUserService(IHttpContextAccessor httpContextAccessor)
        {
            _httpContextAccessor = httpContextAccessor;
        }

        public string? GetCurrentUserId()
        {
            return _httpContextAccessor.HttpContext?.User?.FindFirstValue(ClaimTypes.NameIdentifier);
        }
    }
}


--------------------------------------------------------------------------------

// File: D:\docs\test\Decode\DreamDecode\DreamDecode.Application\Interpretation\Interfaces\IAdminManagement.cs

using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using DreamDecode.Application.User.DTOs;

namespace DreamDecode.Application.Interpretation.Interfaces
{
    public interface IAdminManagement
    {
        Task<string> AddAdminAsync(RegisterDto dto);
        Task<string> DeleteAdminAsync(string email);
    }

}


--------------------------------------------------------------------------------

// File: D:\docs\test\Decode\DreamDecode\DreamDecode.Application\Interpretation\Services\AdminManagementService.cs

using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using DreamDecode.Application.Interpretation.Interfaces;
using DreamDecode.Application.User.DTOs;
using DreamDecode.Domain.User.Entities;
using DreamDecode.Domain.User.Enums;
using Microsoft.AspNetCore.Identity;

namespace DreamDecode.Application.Interpretation.Services
{
    public class AdminManagementService : IAdminManagement
    {
        private readonly UserManager<ApplicationUser> _users;
        private readonly RoleManager<IdentityRole> _roles;

        public AdminManagementService(UserManager<ApplicationUser> users, RoleManager<IdentityRole> roles)
        {
            _users = users;
            _roles = roles;
        }
         
        public async Task<string> AddAdminAsync(RegisterDto dto)
        {
           
            if (!await _roles.RoleExistsAsync(Roles.Admin.ToString()))
                await _roles.CreateAsync(new IdentityRole(Roles.Admin.ToString()));

            var exists = await _users.FindByEmailAsync(dto.Email);
            if (exists != null)
                return "Email already exists.";

            var user = new ApplicationUser
            {
                Email = dto.Email,
                UserName = dto.Email,
                FullName = dto.FullName
            };

            var result = await _users.CreateAsync(user, dto.Password);
            if (!result.Succeeded)
                return string.Join(", ", result.Errors.Select(e => e.Description));

            await _users.AddToRoleAsync(user, Roles.Admin.ToString());
            return "Admin registered successfully.";
        }

        public async Task<string> DeleteAdminAsync(string email)
        {
            var user = await _users.FindByEmailAsync(email);
            if (user == null) return "Admin not found.";

            var roles = await _users.GetRolesAsync(user);
            if (!roles.Contains(Roles.Admin.ToString()))
                return "User is not an admin.";

            await _users.DeleteAsync(user);
            return "Admin deleted successfully.";
        }
    }

}


--------------------------------------------------------------------------------

// File: D:\docs\test\Decode\DreamDecode\DreamDecode.Application\User\DTOs\AuthResultDto.cs

using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace DreamDecode.Application.User.DTOs
{
    public class AuthResultDto
    {
        public bool Succeeded { get; set; }
        public string? Token { get; set; }
        public string? Role { get; set; }
        public IEnumerable<string>? Errors { get; set; }
    }
}


--------------------------------------------------------------------------------

// File: D:\docs\test\Decode\DreamDecode\DreamDecode.Application\User\DTOs\LoginDto.cs

using System;
using System.Collections.Generic;
using System.ComponentModel.DataAnnotations;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace DreamDecode.Application.User.DTOs
{
    public class LoginDto
    {
        [Required, EmailAddress] public string Email { get; set; } = "";
        [Required] public string Password { get; set; } = "";
    }
}


--------------------------------------------------------------------------------

// File: D:\docs\test\Decode\DreamDecode\DreamDecode.Application\User\DTOs\RegisterDto.cs

using System;
using System.Collections.Generic;
using System.ComponentModel.DataAnnotations;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using DreamDecode.Domain.User.Enums;

namespace DreamDecode.Application.User.DTOs
{
    public class RegisterDto
    {
        [Required, EmailAddress] public string Email { get; set; } = "";
        [Required] public string FullName { get; set; } = "";
        // at least 6, one upper, one number, one special
        [Required, RegularExpression(@"^(?=.*[A-Z])(?=.*\d)(?=.*[^A-Za-z0-9]).{7,}$",
            ErrorMessage = "Password must be 7+ chars, include uppercase, number, special.")]
        public string Password { get; set; } = "";
        public string Role { get; set; }  
    }

}


--------------------------------------------------------------------------------

// File: D:\docs\test\Decode\DreamDecode\DreamDecode.Application\User\Interfaces\IAuthService.cs

using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using DreamDecode.Application.User.DTOs;

namespace DreamDecode.Application.User.Interfaces
{
    public interface IAuthService
    {
        Task<AuthResultDto> RegisterAsync(RegisterDto dto);
        Task<AuthResultDto> LoginAsync(LoginDto dto);
    }
}


--------------------------------------------------------------------------------

// File: D:\docs\test\Decode\DreamDecode\DreamDecode.Application\User\Services\AuthService.cs

using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using DreamDecode.Application.User.DTOs;
using DreamDecode.Application.User.Interfaces;
using DreamDecode.Domain.User.Entities;
using DreamDecode.Domain.User.Enums;
using DreamDecode.Domain.User.Factory;
using Microsoft.AspNetCore.Identity;

namespace DreamDecode.Application.User.Services
{
    
    public class AuthService : IAuthService
    {
        private readonly UserManager<ApplicationUser> _users;
        private readonly SignInManager<ApplicationUser> _signIn;
        private readonly RoleManager<IdentityRole> _roles;
        private readonly IJwtFactory _jwt;

        public AuthService(UserManager<ApplicationUser> users,
                           SignInManager<ApplicationUser> signIn,
                           RoleManager<IdentityRole> roles,
                           IJwtFactory jwt)
        {
            _users = users;
            _signIn = signIn;
            _roles = roles; 
            _jwt = jwt;
        }

        public async Task<AuthResultDto> RegisterAsync(RegisterDto dto)
        {
            var exists = await _users.FindByEmailAsync(dto.Email);
            if (exists != null)
                return new AuthResultDto { Succeeded = false, Errors = new[] { "Email already registered." } };

            if (!await _roles.RoleExistsAsync(dto.Role))
                await _roles.CreateAsync(new IdentityRole(dto.Role));

            var user = new ApplicationUser
            {
                Email = dto.Email,
                UserName = dto.Email,
                FullName = dto.FullName
            };

            var create = await _users.CreateAsync(user, dto.Password);
            if (!create.Succeeded)
                return new AuthResultDto { Succeeded = false, Errors = create.Errors.Select(e => e.Description) };

            await _users.AddToRoleAsync(user, dto.Role);

            var token = _jwt.Create(user, dto.Role);
            return new AuthResultDto { Succeeded = true, Token = token, Role = dto.Role };
        }

        public async Task<AuthResultDto> LoginAsync(LoginDto dto)
        {
            var user = await _users.FindByEmailAsync(dto.Email);
            if (user == null)
                return new AuthResultDto { Succeeded = false, Errors = new[] { "Invalid credentials." } };

            var ok = await _signIn.CheckPasswordSignInAsync(user, dto.Password, false);
            if (!ok.Succeeded)
                return new AuthResultDto { Succeeded = false, Errors = new[] { "Invalid credentials." } };

            var roles = await _users.GetRolesAsync(user);
            var role = roles.FirstOrDefault();

            var token = _jwt.Create(user, role);
            return new AuthResultDto { Succeeded = true, Token = token, Role = role };
        }
    }

}


--------------------------------------------------------------------------------

// File: D:\docs\test\Decode\DreamDecode\DreamDecode.Domain\Dream\Entities\DreamEntity.cs

using System;
using System.Collections.Generic;
using System.ComponentModel.DataAnnotations;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using DreamDecode.Domain.User.Entities;

namespace DreamDecode.Domain.Dream.Entities
{
    public class DreamEntity
    {
        [Key]
        public int DreamId { get; set; }

        public string UserId { get; set; } // FK -> ApplicationUser
        public ApplicationUser User { get; set; } // Navigation Property

        public string Title { get; set; }       // Short title for dream
        public string Description { get; set; } // Full dream text

        public DateTime SubmittedAt { get; set; } = DateTime.UtcNow; // Auto-set

        public bool IsInterpreted { get; set; } = false; // Default false
        public bool IsPaid { get; set; } = false;        // Default false
    }
}


--------------------------------------------------------------------------------

// File: D:\docs\test\Decode\DreamDecode\DreamDecode.Domain\User\Entities\ApplicationUser.cs

using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Identity;

namespace DreamDecode.Domain.User.Entities
{
    public class ApplicationUser:IdentityUser
    {
        public string FullName { get; set; }
       
    }
}


--------------------------------------------------------------------------------

// File: D:\docs\test\Decode\DreamDecode\DreamDecode.Domain\User\Enums\Roles.cs

using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace DreamDecode.Domain.User.Enums
{
    public enum Roles
    {
        Admin,
        User
    }
}


--------------------------------------------------------------------------------

// File: D:\docs\test\Decode\DreamDecode\DreamDecode.Domain\User\Factory\IJwtFactory.cs

using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using DreamDecode.Domain.User.Entities;

namespace DreamDecode.Domain.User.Factory
{
    public interface IJwtFactory
    {
        string Create(ApplicationUser user, string role);
    }
}


--------------------------------------------------------------------------------

// File: D:\docs\test\Decode\DreamDecode\DreamDecode.Infrastructure\DependancyInjection.cs

using System;
using System.Collections.Generic;
using System.Linq;
using System.Security.Claims;
using System.Text;
using System.Threading.Tasks;
using DreamDecode.Domain.User.Entities;
using DreamDecode.Domain.User.Factory;
using DreamDecode.Infrastructure.Data;
using DreamDecode.Infrastructure.Factory;
using Microsoft.AspNetCore.Authentication.JwtBearer;
using Microsoft.AspNetCore.Components.Authorization;
using Microsoft.AspNetCore.Identity;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.IdentityModel.Tokens;

namespace DreamDecode.Infrastructure
{
    public static class DependencyInjection
    {
        public static IServiceCollection AddInfrastructure(this IServiceCollection services, IConfiguration cfg)
        {
            services.AddDbContext<AppDbContext>(o =>
                o.UseSqlServer(cfg.GetConnectionString("DefaultConnection")));

            services.AddIdentity<ApplicationUser, IdentityRole>(opts =>
            {
                opts.Password.RequireDigit = true;
                opts.Password.RequiredLength = 7;
                opts.Password.RequireUppercase = true;
                opts.Password.RequireNonAlphanumeric = true;
            })
            .AddEntityFrameworkStores<AppDbContext>()
            .AddDefaultTokenProviders();

            services.AddScoped<IJwtFactory, JwtTokenFactory>();
           


            return services;
        }
    }

}


--------------------------------------------------------------------------------

// File: D:\docs\test\Decode\DreamDecode\DreamDecode.Infrastructure\Data\AppDbContext.cs

using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using DreamDecode.Domain.Dream.Entities;
using DreamDecode.Domain.User.Entities;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Identity.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore;

namespace DreamDecode.Infrastructure.Data
{
    public class AppDbContext:IdentityDbContext<ApplicationUser>
    {
        public AppDbContext(DbContextOptions<AppDbContext> options) : base(options) { }

        public DbSet<DreamEntity> Dreams { get; set; } 

    }
}


--------------------------------------------------------------------------------

// File: D:\docs\test\Decode\DreamDecode\DreamDecode.Infrastructure\Factory\JwtFactory.cs

using System;
using System.Collections.Generic;
using System.IdentityModel.Tokens.Jwt;
using System.Linq;
using System.Security.Claims;
using System.Text;
using System.Threading.Tasks;
using DreamDecode.Domain.User.Entities;
using DreamDecode.Domain.User.Factory;
using Microsoft.Extensions.Configuration;
using Microsoft.IdentityModel.Tokens;

namespace DreamDecode.Infrastructure.Factory
{
    public class JwtTokenFactory : IJwtFactory
    {
        private readonly IConfiguration _cfg;
        public JwtTokenFactory(IConfiguration cfg) => _cfg = cfg;

        public string Create(ApplicationUser user, string role)
        {
            var claims = new List<Claim>
        {
            new(JwtRegisteredClaimNames.Sub, user.Id),
            new(JwtRegisteredClaimNames.Email, user.Email ?? ""),
            new(ClaimTypes.Name, user.UserName ?? ""),
            new("role", role),
            new(ClaimTypes.Role, role)
        };

            var key = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(_cfg["Jwt:Key"]!));
            var creds = new SigningCredentials(key, SecurityAlgorithms.HmacSha256);

            var token = new JwtSecurityToken(
                issuer: _cfg["Jwt:Issuer"],
                audience: _cfg["Jwt:Audience"],
                claims: claims,
                expires: DateTime.UtcNow.AddHours(2),
                signingCredentials: creds
            );

            return new JwtSecurityTokenHandler().WriteToken(token);
        }
    }
}


--------------------------------------------------------------------------------

